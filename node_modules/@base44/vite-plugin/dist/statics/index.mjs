function B(e){let n=e;return!!(n.dataset?.sourceLocation||n.dataset?.visualSelectorId)}function T(e){let n=e;return n.dataset?.sourceLocation||n.dataset?.visualSelectorId||null}var F=["src"];function C(e){if(!e)return[];let n=Array.from(document.querySelectorAll(`[data-source-location="${e}"]`));return n.length>0?n:Array.from(document.querySelectorAll(`[data-visual-selector-id="${e}"]`))}function ee(e,n){e.forEach(r=>{r.setAttribute("class",n)})}function te(e,n,r){F.includes(n)&&e.forEach(l=>{l.setAttribute(n,r)})}function ne(e,n){let r={};for(let l of n){let a=e.getAttribute(l);a!==null&&(r[l]=a)}return r}var oe={position:"absolute",backgroundColor:"#ffffff",border:"1px solid #e2e8f0",borderRadius:"6px",boxShadow:"0 4px 12px rgba(0, 0, 0, 0.15)",fontSize:"12px",minWidth:"120px",maxHeight:"200px",overflowY:"auto",zIndex:"10001",padding:"4px 0",pointerEvents:"auto"},re={padding:"4px 12px",cursor:"pointer",color:"#334155",backgroundColor:"transparent",whiteSpace:"nowrap",lineHeight:"1.5",fontWeight:"400"},R="#526cff",se="#DBEAFE",ie="600",X="#f1f5f9",le=10,M=" \u25BE",H=" \u25B4",ae=12,A="data-layer-dropdown",de=2,ce=2;function Y(e,n){for(let r of Object.keys(n))e.style.setProperty(r.replace(/[A-Z]/g,l=>`-${l.toLowerCase()}`),n[r])}function ue(e){return e.tagName}function G(e,n){let r={element:e,tagName:e.tagName.toLowerCase(),selectorId:T(e)};return n!==void 0&&(r.depth=n),r}function fe(e,n,r){let l=[];function a(u,d){if(!(d>n))for(let p=0;p<u.children.length;p++){let v=u.children[p];if(B(v)){let g={element:v,tagName:v.tagName.toLowerCase(),selectorId:T(v)};r!==void 0&&(g.depth=r+d-1),l.push(g),a(v,d+1)}else a(v,d)}}return a(e,1),l}function Oe(e){let n=[],r=e.parentElement;for(;r&&r!==document.documentElement&&r!==document.body&&n.length<de;)B(r)&&n.push(G(r)),r=r.parentElement;return n.reverse(),n}function He(e,n){return n.forEach((r,l)=>{e.push({...r,depth:l})}),n.length}function pe(e,n,r){e.push(G(n,r));let l=fe(n,ce,r+1);e.push(...l)}function Ae(e){return e.at(-1)?.element??null}function Ne(e,n){let r=fe(e,1);return r.some(l=>l.element===n)||r.push(G(n)),r}function _e(e,n,r,l){let a=T(r),u=new Set;for(let d of n)if(d.element===r)pe(e,r,l),a&&u.add(a);else{let p=d.selectorId;if(p!=null){if(p===a||u.has(p))continue;u.add(p)}e.push({...d,depth:l})}}function me(e){let n=Oe(e),r=[],l=He(r,n),a=Ae(n);if(a){let u=Ne(a,e);_e(r,u,e,l)}else pe(r,e,l);return r}var O=null,N=null,_=null,k=null,P=null;function Pe(e,n,{onSelect:r,onHover:l,onHoverEnd:a}){let u=document.createElement("div");u.textContent=ue(e),Y(u,re);let d=e.depth??0;return d>0&&(u.style.paddingLeft=`${ae+d*le}px`),n&&(u.style.color=R,u.style.backgroundColor=se,u.style.fontWeight=ie),u.addEventListener("mouseenter",()=>{n||(u.style.backgroundColor=X),l&&l(e)}),u.addEventListener("mouseleave",()=>{n||(u.style.backgroundColor="transparent"),a&&a()}),u.addEventListener("click",p=>{p.stopPropagation(),p.preventDefault(),r(e)}),u}function Re(e,n,r){let l=document.createElement("div");return l.setAttribute(A,"true"),Y(l,oe),e.forEach(a=>{let u=a.element===n;l.appendChild(Pe(a,u,r))}),l}function Ee(e){let n=e.textContent??"";n.endsWith(M)||n.endsWith(H)||(e.textContent=n+M,e.style.cursor="pointer",e.style.userSelect="none",e.style.whiteSpace="nowrap",e.style.pointerEvents="auto",e.setAttribute(A,"true"))}function ke(e,n,r,{onSelect:l,onHover:a,onHoverEnd:u}){let d=Array.from(e.children),p=n.findIndex(g=>g.element===r),v=g=>{if(p>=0&&p<d.length){let h=d[p];h.style.color!==R&&(h.style.backgroundColor="transparent")}if(p=g,p>=0&&p<d.length){let h=d[p];h.style.color!==R&&(h.style.backgroundColor=X),h.scrollIntoView({block:"nearest"}),a&&p>=0&&p<n.length&&a(n[p])}};P=g=>{g.key==="ArrowDown"?(g.preventDefault(),g.stopPropagation(),v(p<d.length-1?p+1:0)):g.key==="ArrowUp"?(g.preventDefault(),g.stopPropagation(),v(p>0?p-1:d.length-1)):g.key==="Enter"&&p>=0&&p<n.length&&(g.preventDefault(),g.stopPropagation(),u&&u(),l(n[p]),D())},document.addEventListener("keydown",P,!0)}function We(e,n){let r=!0;_=l=>{if(r){r=!1;return}let a=l.target;!e.contains(a)&&a!==n&&D()},document.addEventListener("mousedown",_,!0)}function ge(e,n,r,l){D();let a=Re(n,r,{...l,onSelect:d=>{l.onHoverEnd&&l.onHoverEnd(),l.onSelect(d),D()}}),u=e.parentElement;u&&(a.style.top=`${e.offsetTop+e.offsetHeight+2}px`,a.style.left=`${e.offsetLeft}px`,u.appendChild(a),O=a,N=e,e.textContent?.endsWith(M.trim())&&(e.textContent=e.textContent.slice(0,-M.length)+H),k=l.onHoverEnd??null,ke(a,n,r,l),We(a,e))}function D(){N?.textContent?.includes(H)&&(N.textContent=N.textContent.replace(H,M)),N=null,k&&(k(),k=null),O&&O.parentNode&&O.remove(),O=null,_&&(document.removeEventListener("mousedown",_,!0),_=null),P&&(document.removeEventListener("keydown",P,!0),P=null)}function he(){return O!==null}function ye(e){let n=null,r=null,l=null,a=()=>{n&&n.parentNode&&n.remove(),n=null},u=I=>{a(),T(I.element)!==e.getSelectedElementId()&&(n=e.createPreviewOverlay(I.element))},d=I=>{a(),D(),r&&(document.removeEventListener("keydown",r,!0),r=null),l=null;let o=e.selectElement(I.element);g(o,I.element)},p=()=>{r&&(document.removeEventListener("keydown",r,!0),r=null),l&&(d(l),l=null)},v=(I,o,f,b,S)=>{I.stopPropagation(),I.preventDefault(),he()?(D(),p()):(l={element:f,tagName:f.tagName.toLowerCase(),selectorId:S},e.onDeselect(),r=y=>{y.key==="Escape"&&(y.stopPropagation(),D(),p())},document.addEventListener("keydown",r,!0),ge(o,b,f,{onSelect:d,onHover:u,onHoverEnd:a}))},g=(I,o)=>{if(!I)return;let f=I.querySelector("div");if(!f)return;let b=me(o);if(b.length<=1)return;let S=T(o);Ee(f),f.addEventListener("click",y=>{v(y,f,o,b,S)})};return{attachToOverlay:g,cleanup:()=>{a(),D()}}}var $="visual-edit-focus-styles",Ve=["div","p","h1","h2","h3","h4","h5","h6","span","li","td","a","button","label"],j=e=>!!e.dataset.arrField,Be=e=>!(!Ve.includes(e.tagName.toLowerCase())||!e.textContent?.trim()||e.querySelector("img, video, canvas, svg")||e.children?.length>0),ve=()=>{if(document.getElementById($))return;let e=document.createElement("style");e.id=$,e.textContent=`
    [data-selected="true"][contenteditable="true"]:focus {
      outline: none !important;
    }
  `,document.head.appendChild(e)},Le=()=>{document.getElementById($)?.remove()},Ie=e=>{let n=document.createRange();n.selectNodeContents(e);let r=window.getSelection();r?.removeAllRanges(),r?.addRange(n)},Fe=e=>!(e instanceof HTMLElement)||!Be(e)?!1:j(e)?!0:e.dataset.dynamicContent!=="true",q=e=>!(e instanceof HTMLElement)||e.dataset.selected!=="true"?!1:Fe(e);var Xe=500;function z(e){let n=null,r=null,l=!1,a=new WeakMap,u=()=>{let o=e.getSelectedElementId();if(!o)return;let f=e.findElementsById(o);e.getSelectedOverlays().forEach((S,y)=>{y<f.length&&f[y]&&e.positionOverlay(S,f[y])})},d=o=>{let f=o.dataset.originalTextContent,b=o.textContent,S=o,y=o.getBoundingClientRect(),x={type:"inline-edit",elementInfo:{tagName:o.tagName,classes:S.className?.baseVal||o.className||"",visualSelectorId:e.getSelectedElementId(),content:b,dataSourceLocation:o.dataset.sourceLocation,isDynamicContent:o.dataset.dynamicContent==="true",linenumber:o.dataset.linenumber,filename:o.dataset.filename,position:{top:y.top,left:y.left,right:y.right,bottom:y.bottom,width:y.width,height:y.height,centerX:y.left+y.width/2,centerY:y.top+y.height/2}},originalContent:f,newContent:b};j(o)&&(x.arrIndex=o.dataset.arrIndex,x.arrVariableName=o.dataset.arrVariableName,x.arrField=o.dataset.arrField),window.parent.postMessage(x,"*"),o.dataset.originalTextContent=b||""},p=o=>{r&&clearTimeout(r),r=setTimeout(()=>d(o),Xe)},v=o=>{u(),p(o)},g=function(){v(this)},h=o=>{ve(),o.dataset.originalTextContent=o.textContent||"",o.dataset.originalCursor=o.style.cursor,o.contentEditable="true";let f=new AbortController;a.set(o,f),o.addEventListener("input",g,{signal:f.signal}),o.style.cursor="text",Ie(o),setTimeout(()=>{o.isConnected&&o.focus()},0)},I=o=>{let f=a.get(o);f&&(f.abort(),a.delete(o)),o.isConnected&&(Le(),o.contentEditable="false",delete o.dataset.originalTextContent,o.dataset.originalCursor!==void 0&&(o.style.cursor=o.dataset.originalCursor,delete o.dataset.originalCursor))};return{get enabled(){return l},set enabled(o){l=o},isEditing(){return n!==null},getCurrentElement(){return n},canEdit(o){return q(o)},startEditing(o){n=o,e.getSelectedOverlays().forEach(f=>{f.style.display="none"}),h(o),window.parent.postMessage({type:"content-editing-started",visualSelectorId:e.getSelectedElementId()},"*")},stopEditing(){if(!n)return;r&&(clearTimeout(r),r=null),I(n),e.getSelectedOverlays().forEach(f=>{f.style.display=""}),u(),window.parent.postMessage({type:"content-editing-ended",visualSelectorId:e.getSelectedElementId()},"*"),n=null},markElementsSelected(o){o.forEach(f=>{f instanceof HTMLElement&&(f.dataset.selected="true")})},clearSelectedMarks(o){o&&e.findElementsById(o).forEach(f=>{f instanceof HTMLElement&&delete f.dataset.selected})},handleToggleMessage(o){if(!l)return;let f=e.findElementsById(o.dataSourceLocation);if(f.length===0||!(f[0]instanceof HTMLElement))return;let b=f[0];if(o.inlineEditingMode){if(!q(b))return;e.getSelectedElementId()!==o.dataSourceLocation&&(this.stopEditing(),e.clearSelection(),this.markElementsSelected(f),e.createSelectionOverlays(f,o.dataSourceLocation)),this.startEditing(b)}else n===b&&this.stopEditing()},cleanup(){this.stopEditing()}}}function Ye(){let e=!1,n=!1,r=!1,l=[],a=[],u=[],d=null,p=50,v=(s=!1)=>{let t=document.createElement("div");return t.style.position="absolute",t.style.pointerEvents="none",t.style.transition="all 0.1s ease-in-out",t.style.zIndex="9999",s?t.style.border="2px solid #2563EB":(t.style.border="2px solid #95a5fc",t.style.backgroundColor="rgba(99, 102, 241, 0.05)"),t},g=(s,t,i=!1)=>{if(!t||!e)return;t.offsetWidth;let c=t.getBoundingClientRect();s.style.top=`${c.top+window.scrollY}px`,s.style.left=`${c.left+window.scrollX}px`,s.style.width=`${c.width}px`,s.style.height=`${c.height}px`;let E=s.querySelector("div");E||(E=document.createElement("div"),E.textContent=t.tagName.toLowerCase(),E.style.position="absolute",E.style.top="-27px",E.style.left="-2px",E.style.padding="2px 8px",E.style.fontSize="11px",E.style.fontWeight=i?"500":"400",E.style.color=i?"#ffffff":"#526cff",E.style.backgroundColor=i?"#526cff":"#DBEAFE",E.style.borderRadius="3px",E.style.minWidth="24px",E.style.textAlign="center",s.appendChild(E))},h=z({findElementsById:C,getSelectedElementId:()=>d,getSelectedOverlays:()=>a,positionOverlay:g,clearSelection:()=>{h.clearSelectedMarks(d),f(),d=null},createSelectionOverlays:(s,t)=>{s.forEach(i=>{let m=v(!0);document.body.appendChild(m),a.push(m),g(m,i,!0)}),d=t}}),I=()=>{h.clearSelectedMarks(d),f(),d=null},o=()=>{l.forEach(s=>{s&&s.parentNode&&s.remove()}),l=[],u=[]},f=()=>{a.forEach(s=>{s&&s.parentNode&&s.remove()}),a=[]},b=["p","h1","h2","h3","h4","h5","h6","span","a","label"],S=s=>{let t=s,i=s.getBoundingClientRect(),m=s,c=b.includes(s.tagName?.toLowerCase()),E=t.closest("[data-arr-variable-name]"),L=E?.dataset?.arrVariableName||null,w=E?.dataset?.arrIndex,V=w!=null?parseInt(w,10):null,Me=t.dataset?.arrField||null;window.parent.postMessage({type:"element-selected",tagName:s.tagName,classes:m.className?.baseVal||s.className||"",visualSelectorId:T(s),content:c?t.innerText:void 0,dataSourceLocation:t.dataset.sourceLocation,isDynamicContent:t.dataset.dynamicContent==="true",linenumber:t.dataset.linenumber,filename:t.dataset.filename,position:{top:i.top,left:i.left,right:i.right,bottom:i.bottom,width:i.width,height:i.height,centerX:i.left+i.width/2,centerY:i.top+i.height/2},attributes:ne(s,F),isTextElement:c,staticArrayName:L,staticArrayIndex:V,staticArrayField:Me},"*")},y=s=>{let t=T(s);return f(),C(t||null).forEach(m=>{let c=v(!0);document.body.appendChild(c),a.push(c),g(c,m,!0)}),d=t||null,o(),S(s),a[0]},x=()=>{d=null,window.parent.postMessage({type:"unselect-element"},"*")},U=s=>{if(!e||n||h.isEditing())return;let t=s.target;if(r){o();return}if(t.tagName.toLowerCase()==="path"){o();return}let i=t.closest("[data-source-location], [data-visual-selector-id]");if(!i){o();return}let m=i,c=m.dataset.sourceLocation||m.dataset.visualSelectorId;if(d===c){o();return}let E=C(c||null);o(),E.forEach(L=>{let w=v(!1);document.body.appendChild(w),l.push(w),g(w,L)}),u=E},K=()=>{n||o()},Z=s=>{if(!e)return;let t=s.target;if(t.closest(`[${A}]`)||h.enabled&&t instanceof HTMLElement&&t.contentEditable==="true")return;if(h.isEditing()){s.preventDefault(),s.stopPropagation(),s.stopImmediatePropagation(),h.stopEditing();return}if(r){s.preventDefault(),s.stopPropagation(),s.stopImmediatePropagation(),window.parent.postMessage({type:"close-dropdowns"},"*");return}if(t.tagName.toLowerCase()==="path")return;s.preventDefault(),s.stopPropagation(),s.stopImmediatePropagation();let i=t.closest("[data-source-location], [data-visual-selector-id]");if(!i)return;let m=i,c=T(i);if(d===c&&m.dataset.selected==="true"&&h.enabled&&h.canEdit(m)){h.startEditing(m);return}h.stopEditing(),h.enabled&&h.markElementsSelected(C(c));let L=y(i);J.attachToOverlay(L,i)},be=()=>{h.stopEditing(),I()},we=(s,t)=>{let i=C(s);i.length!==0&&(ee(i,t),setTimeout(()=>{d===s&&a.forEach((m,c)=>{c<i.length&&g(m,i[c])}),u.length>0&&u[0]?.dataset?.visualSelectorId===s&&l.forEach((E,L)=>{L<u.length&&g(E,u[L])})},p))},Te=(s,t,i)=>{let m=C(s);m.length!==0&&(te(m,t,i),setTimeout(()=>{d===s&&a.forEach((c,E)=>{E<m.length&&g(c,m[E])})},p))},Ce=(s,t,i)=>{let m=C(s);m.length!==0&&(i!=null&&(m=m.filter(c=>c.dataset.arrIndex===String(i))),m.forEach(c=>{c.innerText=t}),setTimeout(()=>{d===s&&a.forEach((c,E)=>{E<m.length&&g(c,m[E])})},p))},J=ye({createPreviewOverlay:s=>{let t=v(!1);return t.style.zIndex="9998",document.body.appendChild(t),g(t,s),t},getSelectedElementId:()=>d,selectElement:y,onDeselect:x}),Se=s=>{e=s,s?(document.body.style.cursor="crosshair",document.addEventListener("mouseover",U),document.addEventListener("mouseout",K),document.addEventListener("click",Z,!0)):(h.stopEditing(),I(),J.cleanup(),o(),u=[],document.body.style.cursor="default",document.removeEventListener("mouseover",U),document.removeEventListener("mouseout",K),document.removeEventListener("click",Z,!0))},Q=()=>{if(d){let s=C(d);if(s.length>0){let i=s[0].getBoundingClientRect(),m=window.innerHeight,c=window.innerWidth,E=i.top<m&&i.bottom>0&&i.left<c&&i.right>0,L={top:i.top,left:i.left,right:i.right,bottom:i.bottom,width:i.width,height:i.height,centerX:i.left+i.width/2,centerY:i.top+i.height/2};window.parent.postMessage({type:"element-position-update",position:L,isInViewport:E,visualSelectorId:d},"*")}}},De=s=>{let t=s.data;switch(t.type){case"toggle-visual-edit-mode":Se(t.data.enabled),t.data.specs?.newInlineEditEnabled!==void 0&&(h.enabled=t.data.specs.newInlineEditEnabled);break;case"update-classes":t.data&&t.data.classes!==void 0?we(t.data.visualSelectorId,t.data.classes):console.warn("[VisualEditAgent] Invalid update-classes message:",t);break;case"update-attribute":t.data&&t.data.visualSelectorId&&t.data.attribute!==void 0&&t.data.value!==void 0?Te(t.data.visualSelectorId,t.data.attribute,t.data.value):console.warn("[VisualEditAgent] Invalid update-attribute message:",t);break;case"unselect-element":be();break;case"refresh-page":window.location.reload();break;case"update-content":t.data&&t.data.content!==void 0?Ce(t.data.visualSelectorId,t.data.content,t.data.arrIndex):console.warn("[VisualEditAgent] Invalid update-content message:",t);break;case"request-element-position":if(d){let i=C(d);if(i.length>0){let c=i[0].getBoundingClientRect(),E=window.innerHeight,L=window.innerWidth,w=c.top<E&&c.bottom>0&&c.left<L&&c.right>0,V={top:c.top,left:c.left,right:c.right,bottom:c.bottom,width:c.width,height:c.height,centerX:c.left+c.width/2,centerY:c.top+c.height/2};window.parent.postMessage({type:"element-position-update",position:V,isInViewport:w,visualSelectorId:d},"*")}}break;case"popover-drag-state":t.data&&t.data.isDragging!==void 0&&(n=t.data.isDragging,t.data.isDragging&&o());break;case"dropdown-state":t.data&&t.data.isOpen!==void 0&&(r=t.data.isOpen,t.data.isOpen&&o());break;case"toggle-inline-edit-mode":t.data&&h.handleToggleMessage(t.data);break;default:break}},W=()=>{if(d){let s=C(d);a.forEach((t,i)=>{i<s.length&&g(t,s[i])})}u.length>0&&l.forEach((s,t)=>{t<u.length&&g(s,u[t])})};document.querySelectorAll("[data-linenumber]:not([data-visual-selector-id])").forEach((s,t)=>{let i=s,m=`visual-id-${i.dataset.filename}-${i.dataset.linenumber}-${t}`;i.dataset.visualSelectorId=m});let xe=new MutationObserver(s=>{s.some(i=>{let m=E=>{if(E.nodeType===Node.ELEMENT_NODE){let L=E;if(L.dataset&&L.dataset.visualSelectorId)return!0;for(let w=0;w<L.children.length;w++)if(m(L.children[w]))return!0}return!1};return i.type==="attributes"&&(i.attributeName==="style"||i.attributeName==="class"||i.attributeName==="width"||i.attributeName==="height")&&m(i.target)})&&setTimeout(W,p)});window.addEventListener("message",De),window.addEventListener("scroll",Q,!0),document.addEventListener("scroll",Q,!0),window.addEventListener("resize",W),window.addEventListener("scroll",W),xe.observe(document.body,{attributes:!0,childList:!0,subtree:!0,attributeFilter:["style","class","width","height"]}),window.parent.postMessage({type:"visual-edit-agent-ready"},"*")}export{Ye as setupVisualEditAgent};
//# sourceMappingURL=index.mjs.map