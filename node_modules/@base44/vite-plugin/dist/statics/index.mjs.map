{"version":3,"sources":["../../src/injections/utils.ts","../../src/injections/layer-dropdown/consts.ts","../../src/injections/layer-dropdown/utils.ts","../../src/injections/layer-dropdown/dropdown-ui.ts","../../src/injections/layer-dropdown/controller.ts","../../src/capabilities/inline-edit/dom-utils.ts","../../src/capabilities/inline-edit/controller.ts","../../src/injections/visual-edit-agent.ts"],"sourcesContent":["/** Check if an element has instrumentation attributes */\nexport function isInstrumentedElement(element: Element): boolean {\n  const htmlEl = element as HTMLElement;\n  return !!(\n    htmlEl.dataset?.sourceLocation || htmlEl.dataset?.visualSelectorId\n  );\n}\n\n/** Get the selector ID from an element's data attributes (prefers source-location) */\nexport function getElementSelectorId(element: Element): string | null {\n  const htmlEl = element as HTMLElement;\n  return (\n    htmlEl.dataset?.sourceLocation ||\n    htmlEl.dataset?.visualSelectorId ||\n    null\n  );\n}\n\nexport const ALLOWED_ATTRIBUTES: string[] = [\"src\"];\n\n/** Find elements by ID - first try data-source-location, fallback to data-visual-selector-id */\nexport function findElementsById(id: string | null): Element[] {\n  if (!id) return [];\n  const sourceElements = Array.from(\n    document.querySelectorAll(`[data-source-location=\"${id}\"]`)\n  );\n  if (sourceElements.length > 0) {\n    return sourceElements;\n  }\n  return Array.from(\n    document.querySelectorAll(`[data-visual-selector-id=\"${id}\"]`)\n  );\n}\n\n/**\n * Update element classes by visual selector ID.\n * Uses setAttribute instead of className to support both HTML and SVG elements.\n */\nexport function updateElementClasses(elements: Element[], classes: string): void {\n  elements.forEach((element) => {\n    element.setAttribute(\"class\", classes);\n  });\n}\n\n/** Set a single attribute on all provided elements. */\nexport function updateElementAttribute(elements: Element[], attribute: string, value: string): void {\n  if (!ALLOWED_ATTRIBUTES.includes(attribute)) {\n    return;\n  }\n\n  elements.forEach((element) => {\n    element.setAttribute(attribute, value);\n  });\n}\n\n/** Collect attribute values from an element for a given allowlist. */\nexport function collectAllowedAttributes(element: Element, allowedAttributes: string[]): Record<string, string> {\n  const attributes: Record<string, string> = {};\n  for (const attr of allowedAttributes) {\n    const val = element.getAttribute(attr);\n    if (val !== null) {\n      attributes[attr] = val;\n    }\n  }\n  return attributes;\n}\n","/** Style constants for the layer dropdown UI */\n\nexport const DROPDOWN_CONTAINER_STYLES: Record<string, string> = {\n  position: \"absolute\",\n  backgroundColor: \"#ffffff\",\n  border: \"1px solid #e2e8f0\",\n  borderRadius: \"6px\",\n  boxShadow: \"0 4px 12px rgba(0, 0, 0, 0.15)\",\n  fontSize: \"12px\",\n  minWidth: \"120px\",\n  maxHeight: \"200px\",\n  overflowY: \"auto\",\n  zIndex: \"10001\",\n  padding: \"4px 0\",\n  pointerEvents: \"auto\",\n};\n\nexport const DROPDOWN_ITEM_BASE_STYLES: Record<string, string> = {\n  padding: \"4px 12px\",\n  cursor: \"pointer\",\n  color: \"#334155\",\n  backgroundColor: \"transparent\",\n  whiteSpace: \"nowrap\",\n  lineHeight: \"1.5\",\n  fontWeight: \"400\",\n};\n\nexport const DROPDOWN_ITEM_ACTIVE_COLOR = \"#526cff\";\nexport const DROPDOWN_ITEM_ACTIVE_BG = \"#DBEAFE\";\nexport const DROPDOWN_ITEM_ACTIVE_FONT_WEIGHT = \"600\";\n\nexport const DROPDOWN_ITEM_HOVER_BG = \"#f1f5f9\";\n\nexport const DEPTH_INDENT_PX = 10;\n\n/** Chevron shown when dropdown is collapsed (click to expand) */\nexport const CHEVRON_COLLAPSED = \" \\u25BE\";\n/** Chevron shown when dropdown is expanded (click to collapse) */\nexport const CHEVRON_EXPANDED = \" \\u25B4\";\n\nexport const BASE_PADDING_PX = 12;\n\nexport const LAYER_DROPDOWN_ATTR = \"data-layer-dropdown\";\n\n/** Max instrumented ancestors to show above the selected element */\nexport const MAX_PARENT_DEPTH = 2;\n\n/** Max instrumented depth levels to show below the selected element */\nexport const MAX_CHILD_DEPTH = 2;\n","/** DOM utilities for the layer-dropdown module */\n\nimport { isInstrumentedElement, getElementSelectorId } from \"../utils.js\";\nimport { MAX_PARENT_DEPTH, MAX_CHILD_DEPTH } from \"./consts.js\";\n\nimport type { LayerInfo } from \"./types.js\";\n\n/** Apply a style map to an element */\nexport function applyStyles(element: HTMLElement, styles: Record<string, string>): void {\n  for (const key of Object.keys(styles)) {\n    element.style.setProperty(\n      key.replace(/[A-Z]/g, (m) => `-${m.toLowerCase()}`),\n      styles[key]!\n    );\n  }\n}\n\n/** Display name for a layer — just the real tag name */\nexport function getLayerDisplayName(layer: LayerInfo): string {\n  return layer.tagName;\n}\n\nfunction toLayerInfo(element: Element, depth?: number): LayerInfo {\n  const info: LayerInfo = {\n    element,\n    tagName: element.tagName.toLowerCase(),\n    selectorId: getElementSelectorId(element),\n  };\n  if (depth !== undefined) info.depth = depth;\n  return info;\n}\n\n/**\n * Collect instrumented descendants up to `maxDepth` instrumented nesting levels.\n * Non-instrumented wrappers are walked through without counting toward depth.\n * Results are in DOM order.\n * When `startDepth` is provided, assigns `depth` to each item during collection.\n */\nexport function getInstrumentedDescendants(\n  parent: Element,\n  maxDepth: number,\n  startDepth?: number\n): LayerInfo[] {\n  const result: LayerInfo[] = [];\n\n  function walk(el: Element, instrDepth: number): void {\n    if (instrDepth > maxDepth) return;\n    for (let i = 0; i < el.children.length; i++) {\n      const child = el.children[i]!;\n      if (isInstrumentedElement(child)) {\n        const info: LayerInfo = {\n          element: child,\n          tagName: child.tagName.toLowerCase(),\n          selectorId: getElementSelectorId(child),\n        };\n        if (startDepth !== undefined) {\n          info.depth = startDepth + instrDepth - 1;\n        }\n        result.push(info);\n        walk(child, instrDepth + 1);\n      } else {\n        walk(child, instrDepth);\n      }\n    }\n  }\n\n  walk(parent, 1);\n  return result;\n}\n\n/** Collect instrumented ancestors from selected element up to MAX_PARENT_DEPTH (outermost first). */\nfunction collectInstrumentedParents(selectedElement: Element): LayerInfo[] {\n  const parents: LayerInfo[] = [];\n  let current = selectedElement.parentElement;\n  while (\n    current &&\n    current !== document.documentElement &&\n    current !== document.body &&\n    parents.length < MAX_PARENT_DEPTH\n  ) {\n    if (isInstrumentedElement(current)) {\n      parents.push(toLayerInfo(current));\n    }\n    current = current.parentElement;\n  }\n  parents.reverse();\n  return parents;\n}\n\n/** Add parents to chain with depth 0, 1, …; returns depth of selected (parents.length). */\nfunction addParentsToChain(chain: LayerInfo[], parents: LayerInfo[]): number {\n  parents.forEach((p, i) => {\n    chain.push({ ...p, depth: i });\n  });\n  return parents.length;\n}\n\n/** Add selected element and its descendants at the given depth. */\nfunction addSelfAndDescendantsToChain(\n  chain: LayerInfo[],\n  selectedElement: Element,\n  selfDepth: number\n): void {\n  chain.push(toLayerInfo(selectedElement, selfDepth));\n  const descendants = getInstrumentedDescendants(\n    selectedElement,\n    MAX_CHILD_DEPTH,\n    selfDepth + 1\n  );\n  chain.push(...descendants);\n}\n\n/** Get the innermost instrumented parent's DOM element, or null if none. */\nfunction getImmediateInstrParent(parents: LayerInfo[]): Element | null {\n  return parents.at(-1)?.element ?? null;\n}\n\n/** Collect instrumented siblings of the selected element from its parent (DOM order). */\nfunction collectSiblings(parent: Element, selectedElement: Element): LayerInfo[] {\n  const siblings = getInstrumentedDescendants(parent, 1);\n  if (!siblings.some((s) => s.element === selectedElement)) {\n    siblings.push(toLayerInfo(selectedElement));\n  }\n  return siblings;\n}\n\n/** Add siblings at selfDepth, expanding children only for the selected element. */\nfunction appendSiblingsWithSelected(\n  chain: LayerInfo[],\n  siblings: LayerInfo[],\n  selectedElement: Element,\n  selfDepth: number\n): void {\n  const selectedSelectorId = getElementSelectorId(selectedElement);\n  const seen = new Set<string>();\n  for (const sibling of siblings) {\n    if (sibling.element === selectedElement) {\n      addSelfAndDescendantsToChain(chain, selectedElement, selfDepth);\n      if (selectedSelectorId) seen.add(selectedSelectorId);\n    } else {\n      const id = sibling.selectorId;\n      if (id != null) {\n        if (id === selectedSelectorId || seen.has(id)) continue;\n        seen.add(id);\n      }\n      chain.push({ ...sibling, depth: selfDepth });\n    }\n  }\n}\n\n/**\n * Build the layer chain for the dropdown:\n *\n *   Parents  – up to MAX_PARENT_DEPTH instrumented ancestors, outer → inner.\n *   Siblings – instrumented children of the immediate parent, at the same depth.\n *   Current  – the selected element (highlighted), with children expanded.\n *   Children – instrumented descendants within MAX_CHILD_DEPTH levels, DOM order.\n *\n * Each item carries a `depth` for visual indentation.\n */\nexport function buildLayerChain(selectedElement: Element): LayerInfo[] {\n  const parents = collectInstrumentedParents(selectedElement);\n  const chain: LayerInfo[] = [];\n  const selfDepth = addParentsToChain(chain, parents);\n\n  const instrParent = getImmediateInstrParent(parents);\n  if (instrParent) {\n    const siblings = collectSiblings(instrParent, selectedElement);\n    appendSiblingsWithSelected(chain, siblings, selectedElement, selfDepth);\n  } else {\n    addSelfAndDescendantsToChain(chain, selectedElement, selfDepth);\n  }\n\n  return chain;\n}\n","/** Dropdown UI component for layer navigation */\n\nimport {\n  DROPDOWN_CONTAINER_STYLES,\n  DROPDOWN_ITEM_BASE_STYLES,\n  DROPDOWN_ITEM_ACTIVE_COLOR,\n  DROPDOWN_ITEM_ACTIVE_BG,\n  DROPDOWN_ITEM_ACTIVE_FONT_WEIGHT,\n  DROPDOWN_ITEM_HOVER_BG,\n  DEPTH_INDENT_PX,\n  BASE_PADDING_PX,\n  CHEVRON_COLLAPSED,\n  CHEVRON_EXPANDED,\n  LAYER_DROPDOWN_ATTR,\n} from \"./consts.js\";\nimport { applyStyles, getLayerDisplayName } from \"./utils.js\";\nimport type { LayerInfo, DropdownCallbacks } from \"./types.js\";\n\nlet activeDropdown: HTMLDivElement | null = null;\nlet activeLabel: HTMLDivElement | null = null;\nlet outsideMousedownHandler: ((e: MouseEvent) => void) | null = null;\nlet activeOnHoverEnd: (() => void) | null = null;\nlet activeKeydownHandler: ((e: KeyboardEvent) => void) | null = null;\n\nfunction createDropdownItem(\n  layer: LayerInfo,\n  isActive: boolean,\n  { onSelect, onHover, onHoverEnd }: DropdownCallbacks\n): HTMLDivElement {\n  const item = document.createElement(\"div\");\n  item.textContent = getLayerDisplayName(layer);\n  applyStyles(item, DROPDOWN_ITEM_BASE_STYLES);\n\n  const depth = layer.depth ?? 0;\n  if (depth > 0) {\n    item.style.paddingLeft = `${BASE_PADDING_PX + depth * DEPTH_INDENT_PX}px`;\n  }\n\n  if (isActive) {\n    item.style.color = DROPDOWN_ITEM_ACTIVE_COLOR;\n    item.style.backgroundColor = DROPDOWN_ITEM_ACTIVE_BG;\n    item.style.fontWeight = DROPDOWN_ITEM_ACTIVE_FONT_WEIGHT;\n  }\n\n  item.addEventListener(\"mouseenter\", () => {\n    if (!isActive) item.style.backgroundColor = DROPDOWN_ITEM_HOVER_BG;\n    if (onHover) onHover(layer);\n  });\n\n  item.addEventListener(\"mouseleave\", () => {\n    if (!isActive) item.style.backgroundColor = \"transparent\";\n    if (onHoverEnd) onHoverEnd();\n  });\n\n  item.addEventListener(\"click\", (e: MouseEvent) => {\n    e.stopPropagation();\n    e.preventDefault();\n    onSelect(layer);\n  });\n\n  return item;\n}\n\n/** Create the dropdown DOM element with layer items */\nexport function createDropdownElement(\n  layers: LayerInfo[],\n  currentElement: Element | null,\n  callbacks: DropdownCallbacks\n): HTMLDivElement {\n  const container = document.createElement(\"div\");\n  container.setAttribute(LAYER_DROPDOWN_ATTR, \"true\");\n  applyStyles(container, DROPDOWN_CONTAINER_STYLES);\n\n  layers.forEach((layer) => {\n    const isActive = layer.element === currentElement;\n    container.appendChild(createDropdownItem(layer, isActive, callbacks));\n  });\n\n  return container;\n}\n\n/** Add chevron indicator and pointer-events to the label */\nexport function enhanceLabelWithChevron(label: HTMLDivElement): void {\n  const t = label.textContent ?? \"\";\n  if (t.endsWith(CHEVRON_COLLAPSED) || t.endsWith(CHEVRON_EXPANDED)) return;\n\n  label.textContent = t + CHEVRON_COLLAPSED;\n  label.style.cursor = \"pointer\";\n  label.style.userSelect = \"none\";\n  label.style.whiteSpace = \"nowrap\";\n  label.style.pointerEvents = \"auto\";\n  label.setAttribute(LAYER_DROPDOWN_ATTR, \"true\");\n}\n\nfunction setupKeyboardNavigation(\n  dropdown: HTMLDivElement,\n  layers: LayerInfo[],\n  currentElement: Element | null,\n  { onSelect, onHover, onHoverEnd }: DropdownCallbacks\n): void {\n  const items = Array.from(dropdown.children) as HTMLDivElement[];\n  let focusedIndex = layers.findIndex((l) => l.element === currentElement);\n\n  const setFocusedItem = (index: number) => {\n    if (focusedIndex >= 0 && focusedIndex < items.length) {\n      const prev = items[focusedIndex]!;\n      if (prev.style.color !== DROPDOWN_ITEM_ACTIVE_COLOR) {\n        prev.style.backgroundColor = \"transparent\";\n      }\n    }\n    focusedIndex = index;\n    if (focusedIndex >= 0 && focusedIndex < items.length) {\n      const cur = items[focusedIndex]!;\n      if (cur.style.color !== DROPDOWN_ITEM_ACTIVE_COLOR) {\n        cur.style.backgroundColor = DROPDOWN_ITEM_HOVER_BG;\n      }\n      cur.scrollIntoView({ block: \"nearest\" });\n      if (onHover && focusedIndex >= 0 && focusedIndex < layers.length) {\n        onHover(layers[focusedIndex]!);\n      }\n    }\n  };\n\n  activeKeydownHandler = (e: KeyboardEvent) => {\n    if (e.key === \"ArrowDown\") {\n      e.preventDefault();\n      e.stopPropagation();\n      setFocusedItem(focusedIndex < items.length - 1 ? focusedIndex + 1 : 0);\n    } else if (e.key === \"ArrowUp\") {\n      e.preventDefault();\n      e.stopPropagation();\n      setFocusedItem(focusedIndex > 0 ? focusedIndex - 1 : items.length - 1);\n    } else if (e.key === \"Enter\" && focusedIndex >= 0 && focusedIndex < layers.length) {\n      e.preventDefault();\n      e.stopPropagation();\n      if (onHoverEnd) onHoverEnd();\n      onSelect(layers[focusedIndex]!);\n      closeDropdown();\n    }\n  };\n  document.addEventListener(\"keydown\", activeKeydownHandler, true);\n}\n\nfunction setupOutsideClickHandler(\n  dropdown: HTMLDivElement,\n  label: HTMLDivElement\n): void {\n  let skipFirst = true;\n  outsideMousedownHandler = (e: MouseEvent) => {\n    if (skipFirst) { skipFirst = false; return; }\n    const target = e.target as Node;\n    if (!dropdown.contains(target) && target !== label) {\n      closeDropdown();\n    }\n  };\n  document.addEventListener(\"mousedown\", outsideMousedownHandler, true);\n}\n\n/** Show the dropdown below the label element */\nexport function showDropdown(\n  label: HTMLDivElement,\n  layers: LayerInfo[],\n  currentElement: Element | null,\n  callbacks: DropdownCallbacks\n): void {\n  closeDropdown();\n\n  const dropdown = createDropdownElement(\n    layers,\n    currentElement,\n    {\n      ...callbacks,\n      onSelect: (layer) => {\n        if (callbacks.onHoverEnd) callbacks.onHoverEnd();\n        callbacks.onSelect(layer);\n        closeDropdown();\n      },\n    }\n  );\n\n  const overlay = label.parentElement;\n  if (!overlay) return;\n\n  dropdown.style.top = `${label.offsetTop + label.offsetHeight + 2}px`;\n  dropdown.style.left = `${label.offsetLeft}px`;\n\n  overlay.appendChild(dropdown);\n  activeDropdown = dropdown;\n  activeLabel = label;\n  if (label.textContent?.endsWith(CHEVRON_COLLAPSED.trim())) {\n    label.textContent = label.textContent.slice(0, -CHEVRON_COLLAPSED.length) + CHEVRON_EXPANDED;\n  }\n  activeOnHoverEnd = callbacks.onHoverEnd ?? null;\n\n  setupKeyboardNavigation(dropdown, layers, currentElement, callbacks);\n  setupOutsideClickHandler(dropdown, label);\n}\n\n/** Close the active dropdown and clean up listeners */\nexport function closeDropdown(): void {\n  if (activeLabel?.textContent?.includes(CHEVRON_EXPANDED)) {\n    activeLabel.textContent = activeLabel.textContent.replace(CHEVRON_EXPANDED, CHEVRON_COLLAPSED);\n  }\n  activeLabel = null;\n\n  if (activeOnHoverEnd) {\n    activeOnHoverEnd();\n    activeOnHoverEnd = null;\n  }\n\n  if (activeDropdown && activeDropdown.parentNode) {\n    activeDropdown.remove();\n  }\n  activeDropdown = null;\n\n  if (outsideMousedownHandler) {\n    document.removeEventListener(\"mousedown\", outsideMousedownHandler, true);\n    outsideMousedownHandler = null;\n  }\n\n  if (activeKeydownHandler) {\n    document.removeEventListener(\"keydown\", activeKeydownHandler, true);\n    activeKeydownHandler = null;\n  }\n}\n\n/** Check if a dropdown is currently visible */\nexport function isDropdownOpen(): boolean {\n  return activeDropdown !== null;\n}\n","/** Controller that encapsulates layer-dropdown integration logic */\n\nimport { getElementSelectorId } from \"../utils.js\";\nimport { buildLayerChain } from \"./utils.js\";\nimport {\n  enhanceLabelWithChevron,\n  showDropdown,\n  closeDropdown,\n  isDropdownOpen,\n} from \"./dropdown-ui.js\";\nimport type { LayerInfo, LayerControllerConfig, LayerController } from \"./types.js\";\n\nexport function createLayerController(config: LayerControllerConfig): LayerController {\n  let layerPreviewOverlay: HTMLDivElement | null = null;\n  let escapeHandler: ((e: KeyboardEvent) => void) | null = null;\n  let dropdownSourceLayer: LayerInfo | null = null;\n\n  const clearLayerPreview = () => {\n    if (layerPreviewOverlay && layerPreviewOverlay.parentNode) {\n      layerPreviewOverlay.remove();\n    }\n    layerPreviewOverlay = null;\n  };\n\n  const showLayerPreview = (layer: LayerInfo) => {\n    clearLayerPreview();\n    if (getElementSelectorId(layer.element) === config.getSelectedElementId()) return;\n\n    layerPreviewOverlay = config.createPreviewOverlay(layer.element);\n  };\n\n  const selectLayer = (layer: LayerInfo) => {\n    clearLayerPreview();\n    closeDropdown();\n    if (escapeHandler) {\n      document.removeEventListener(\"keydown\", escapeHandler, true);\n      escapeHandler = null;\n    }\n    dropdownSourceLayer = null;\n\n    const firstOverlay = config.selectElement(layer.element);\n    attachToOverlay(firstOverlay, layer.element);\n  };\n\n  const restoreSelection = () => {\n    if (escapeHandler) {\n      document.removeEventListener(\"keydown\", escapeHandler, true);\n      escapeHandler = null;\n    }\n    if (dropdownSourceLayer) {\n      selectLayer(dropdownSourceLayer);\n      dropdownSourceLayer = null;\n    }\n  };\n\n  const handleLabelClick = (e: MouseEvent, label: HTMLDivElement, element: Element, layers: LayerInfo[], currentId: string | null) => {\n    e.stopPropagation();\n    e.preventDefault();\n    if (isDropdownOpen()) {\n      closeDropdown();\n      restoreSelection();\n    } else {\n      dropdownSourceLayer = {\n        element,\n        tagName: element.tagName.toLowerCase(),\n        selectorId: currentId,\n      };\n      config.onDeselect();\n\n      escapeHandler = (ev: KeyboardEvent) => {\n        if (ev.key === \"Escape\") {\n          ev.stopPropagation();\n          closeDropdown();\n          restoreSelection();\n        }\n      };\n      document.addEventListener(\"keydown\", escapeHandler, true);\n\n      showDropdown(label, layers, element, { onSelect: selectLayer, onHover: showLayerPreview, onHoverEnd: clearLayerPreview });\n    }\n  };\n\n  const attachToOverlay = (\n    overlay: HTMLDivElement | undefined,\n    element: Element\n  ) => {\n    if (!overlay) return;\n\n    const label = overlay.querySelector(\"div\") as HTMLDivElement | null;\n    if (!label) return;\n\n    const layers = buildLayerChain(element);\n    if (layers.length <= 1) return;\n\n    const currentId = getElementSelectorId(element);\n    enhanceLabelWithChevron(label);\n\n    label.addEventListener(\"click\", (e: MouseEvent) => {\n      handleLabelClick(e, label, element, layers, currentId);\n    });\n  };\n\n  const cleanup = () => {\n    clearLayerPreview();\n    closeDropdown();\n  };\n\n  return { attachToOverlay, cleanup };\n}\n","const FOCUS_STYLE_ID = \"visual-edit-focus-styles\";\n\nconst EDITABLE_TAGS = [\n  \"div\", \"p\", \"h1\", \"h2\", \"h3\", \"h4\", \"h5\", \"h6\",\n  \"span\", \"li\", \"td\", \"a\", \"button\", \"label\",\n];\n\nexport const isStaticArrayTextElement = (element: HTMLElement): boolean => {\n  return !!element.dataset.arrField;\n};\n\nconst passesStructuralChecks = (element: HTMLElement): boolean => {\n  if (!EDITABLE_TAGS.includes(element.tagName.toLowerCase())) return false;\n  if (!element.textContent?.trim()) return false;\n  if (element.querySelector(\"img, video, canvas, svg\")) return false;\n  if (element.children?.length > 0) return false;\n  return true;\n};\n\nexport const injectFocusOutlineCSS = () => {\n  if (document.getElementById(FOCUS_STYLE_ID)) return;\n\n  const style = document.createElement(\"style\");\n  style.id = FOCUS_STYLE_ID;\n  style.textContent = `\n    [data-selected=\"true\"][contenteditable=\"true\"]:focus {\n      outline: none !important;\n    }\n  `;\n  document.head.appendChild(style);\n};\n\nexport const removeFocusOutlineCSS = () => {\n  document.getElementById(FOCUS_STYLE_ID)?.remove();\n};\n\nexport const selectText = (element: HTMLElement) => {\n  const range = document.createRange();\n  range.selectNodeContents(element);\n  const selection = window.getSelection();\n  selection?.removeAllRanges();\n  selection?.addRange(range);\n};\n\nexport const isEditableTextElement = (element: Element): boolean => {\n  if (!(element instanceof HTMLElement)) return false;\n  if (!passesStructuralChecks(element)) return false;\n  if (isStaticArrayTextElement(element)) return true;\n  if (element.dataset.dynamicContent === \"true\") return false;\n  return true;\n};\n\nexport const shouldEnterInlineEditingMode = (element: Element): boolean => {\n  if (!(element instanceof HTMLElement) || element.dataset.selected !== \"true\") {\n    return false;\n  }\n  return isEditableTextElement(element);\n};\n","import type { InlineEditHost, InlineEditController } from \"./types.js\";\nimport {\n  injectFocusOutlineCSS,\n  removeFocusOutlineCSS,\n  selectText,\n  shouldEnterInlineEditingMode,\n  isStaticArrayTextElement,\n} from \"./dom-utils.js\";\n\nconst DEBOUNCE_MS = 500;\n\nexport function createInlineEditController(\n  host: InlineEditHost\n): InlineEditController {\n  let currentEditingElement: HTMLElement | null = null;\n  let debouncedSendTimeout: ReturnType<typeof setTimeout> | null = null;\n  let enabled = false;\n  const listenerAbortControllers = new WeakMap<HTMLElement, AbortController>();\n\n  // --- Private helpers ---\n\n  const repositionOverlays = () => {\n    const selectedId = host.getSelectedElementId();\n    if (!selectedId) return;\n    const elements = host.findElementsById(selectedId);\n    const overlays = host.getSelectedOverlays();\n    overlays.forEach((overlay, i) => {\n      if (i < elements.length && elements[i]) {\n        host.positionOverlay(overlay, elements[i]);\n      }\n    });\n  };\n\n  const reportEdit = (element: HTMLElement) => {\n    const originalContent = element.dataset.originalTextContent;\n    const newContent = element.textContent;\n\n    const svgElement = element as unknown as SVGElement;\n    const rect = element.getBoundingClientRect();\n\n    const message: Record<string, unknown> = {\n      type: \"inline-edit\",\n      elementInfo: {\n        tagName: element.tagName,\n        classes:\n          (svgElement.className as unknown as SVGAnimatedString)?.baseVal ||\n          element.className ||\n          \"\",\n        visualSelectorId: host.getSelectedElementId(),\n        content: newContent,\n        dataSourceLocation: element.dataset.sourceLocation,\n        isDynamicContent: element.dataset.dynamicContent === \"true\",\n        linenumber: element.dataset.linenumber,\n        filename: element.dataset.filename,\n        position: {\n          top: rect.top,\n          left: rect.left,\n          right: rect.right,\n          bottom: rect.bottom,\n          width: rect.width,\n          height: rect.height,\n          centerX: rect.left + rect.width / 2,\n          centerY: rect.top + rect.height / 2,\n        },\n      },\n      originalContent,\n      newContent,\n    };\n\n    if (isStaticArrayTextElement(element)) {\n      message.arrIndex = element.dataset.arrIndex;\n      message.arrVariableName = element.dataset.arrVariableName;\n      message.arrField = element.dataset.arrField;\n    }\n\n    window.parent.postMessage(message, \"*\");\n\n    element.dataset.originalTextContent = newContent || \"\";\n  };\n\n  const debouncedReport = (element: HTMLElement) => {\n    if (debouncedSendTimeout) clearTimeout(debouncedSendTimeout);\n    debouncedSendTimeout = setTimeout(() => reportEdit(element), DEBOUNCE_MS);\n  };\n\n  const onTextInput = (element: HTMLElement) => {\n    repositionOverlays();\n    debouncedReport(element);\n  };\n\n  const handleInputEvent = function (this: HTMLElement) {\n    onTextInput(this);\n  };\n\n  const makeEditable = (element: HTMLElement) => {\n    injectFocusOutlineCSS();\n\n    element.dataset.originalTextContent = element.textContent || \"\";\n    element.dataset.originalCursor = element.style.cursor;\n    element.contentEditable = \"true\";\n\n    const abortController = new AbortController();\n    listenerAbortControllers.set(element, abortController);\n    element.addEventListener(\"input\", handleInputEvent, {\n      signal: abortController.signal,\n    });\n\n    element.style.cursor = \"text\";\n    selectText(element);\n    setTimeout(() => {\n      if (element.isConnected) {\n        element.focus();\n      }\n    }, 0);\n  };\n\n  const makeNonEditable = (element: HTMLElement) => {\n    const abortController = listenerAbortControllers.get(element);\n    if (abortController) {\n      abortController.abort();\n      listenerAbortControllers.delete(element);\n    }\n\n    if (!element.isConnected) return;\n\n    removeFocusOutlineCSS();\n    element.contentEditable = \"false\";\n    delete element.dataset.originalTextContent;\n\n    if (element.dataset.originalCursor !== undefined) {\n      element.style.cursor = element.dataset.originalCursor;\n      delete element.dataset.originalCursor;\n    }\n  };\n\n  // --- Public API ---\n\n  return {\n    get enabled() {\n      return enabled;\n    },\n    set enabled(value: boolean) {\n      enabled = value;\n    },\n\n    isEditing() {\n      return currentEditingElement !== null;\n    },\n\n    getCurrentElement() {\n      return currentEditingElement;\n    },\n\n    canEdit(element: Element) {\n      return shouldEnterInlineEditingMode(element);\n    },\n\n    startEditing(element: HTMLElement) {\n      currentEditingElement = element;\n\n      host.getSelectedOverlays().forEach((o) => {\n        o.style.display = \"none\";\n      });\n\n      makeEditable(element);\n\n      window.parent.postMessage(\n        {\n          type: \"content-editing-started\",\n          visualSelectorId: host.getSelectedElementId(),\n        },\n        \"*\"\n      );\n    },\n\n    stopEditing() {\n      if (!currentEditingElement) return;\n\n      if (debouncedSendTimeout) {\n        clearTimeout(debouncedSendTimeout);\n        debouncedSendTimeout = null;\n      }\n\n      const element = currentEditingElement;\n      makeNonEditable(element);\n\n      host.getSelectedOverlays().forEach((o) => {\n        o.style.display = \"\";\n      });\n\n      repositionOverlays();\n\n      window.parent.postMessage(\n        {\n          type: \"content-editing-ended\",\n          visualSelectorId: host.getSelectedElementId(),\n        },\n        \"*\"\n      );\n\n      currentEditingElement = null;\n    },\n\n    markElementsSelected(elements: Element[]) {\n      elements.forEach((el) => {\n        if (el instanceof HTMLElement) {\n          el.dataset.selected = \"true\";\n        }\n      });\n    },\n\n    clearSelectedMarks(elementId: string | null) {\n      if (!elementId) return;\n      host.findElementsById(elementId).forEach((el) => {\n        if (el instanceof HTMLElement) {\n          delete el.dataset.selected;\n        }\n      });\n    },\n\n    handleToggleMessage(data: { dataSourceLocation: string; inlineEditingMode: boolean }) {\n      if (!enabled) return;\n\n      const elements = host.findElementsById(data.dataSourceLocation);\n      if (elements.length === 0 || !(elements[0] instanceof HTMLElement)) return;\n\n      const element = elements[0];\n\n      if (data.inlineEditingMode) {\n        if (!shouldEnterInlineEditingMode(element)) return;\n\n        // Select the element first if not already selected\n        if (host.getSelectedElementId() !== data.dataSourceLocation) {\n          this.stopEditing();\n          host.clearSelection();\n          this.markElementsSelected(elements);\n          host.createSelectionOverlays(elements, data.dataSourceLocation);\n        }\n        this.startEditing(element);\n      } else {\n        if (currentEditingElement === element) {\n          this.stopEditing();\n        }\n      }\n    },\n\n    cleanup() {\n      this.stopEditing();\n    },\n  };\n}\n","import { findElementsById, updateElementClasses, updateElementAttribute, collectAllowedAttributes, ALLOWED_ATTRIBUTES, getElementSelectorId } from \"./utils.js\";\nimport { createLayerController } from \"./layer-dropdown/controller.js\";\nimport { LAYER_DROPDOWN_ATTR } from \"./layer-dropdown/consts.js\";\nimport { createInlineEditController } from \"../capabilities/inline-edit/index.js\";\n\nexport function setupVisualEditAgent() {\n  // State variables (replacing React useState/useRef)\n  let isVisualEditMode = false;\n  let isPopoverDragging = false;\n  let isDropdownOpen = false;\n  let hoverOverlays: HTMLDivElement[] = [];\n  let selectedOverlays: HTMLDivElement[] = [];\n  let currentHighlightedElements: Element[] = [];\n  let selectedElementId: string | null = null;\n\n  const REPOSITION_DELAY_MS = 50;\n\n  // Create overlay element\n  const createOverlay = (isSelected = false): HTMLDivElement => {\n    const overlay = document.createElement(\"div\");\n    overlay.style.position = \"absolute\";\n    overlay.style.pointerEvents = \"none\";\n    overlay.style.transition = \"all 0.1s ease-in-out\";\n    overlay.style.zIndex = \"9999\";\n\n    if (isSelected) {\n      overlay.style.border = \"2px solid #2563EB\";\n    } else {\n      overlay.style.border = \"2px solid #95a5fc\";\n      overlay.style.backgroundColor = \"rgba(99, 102, 241, 0.05)\";\n    }\n\n    return overlay;\n  };\n\n  // Position overlay relative to element\n  const positionOverlay = (\n    overlay: HTMLDivElement,\n    element: Element,\n    isSelected = false\n  ) => {\n    if (!element || !isVisualEditMode) return;\n\n    const htmlElement = element as HTMLElement;\n    // Force layout recalculation\n    void htmlElement.offsetWidth;\n\n    const rect = element.getBoundingClientRect();\n    overlay.style.top = `${rect.top + window.scrollY}px`;\n    overlay.style.left = `${rect.left + window.scrollX}px`;\n    overlay.style.width = `${rect.width}px`;\n    overlay.style.height = `${rect.height}px`;\n\n    // Check if label already exists in overlay\n    let label = overlay.querySelector(\"div\") as HTMLDivElement | null;\n\n    if (!label) {\n      label = document.createElement(\"div\");\n      label.textContent = element.tagName.toLowerCase();\n      label.style.position = \"absolute\";\n      label.style.top = \"-27px\";\n      label.style.left = \"-2px\";\n      label.style.padding = \"2px 8px\";\n      label.style.fontSize = \"11px\";\n      label.style.fontWeight = isSelected ? \"500\" : \"400\";\n      label.style.color = isSelected ? \"#ffffff\" : \"#526cff\";\n      label.style.backgroundColor = isSelected ? \"#526cff\" : \"#DBEAFE\";\n      label.style.borderRadius = \"3px\";\n      label.style.minWidth = \"24px\";\n      label.style.textAlign = \"center\";\n      overlay.appendChild(label);\n    }\n  };\n\n  // --- Inline edit controller ---\n  const inlineEdit = createInlineEditController({\n    findElementsById,\n    getSelectedElementId: () => selectedElementId,\n    getSelectedOverlays: () => selectedOverlays,\n    positionOverlay,\n    clearSelection: () => {\n      inlineEdit.clearSelectedMarks(selectedElementId);\n      clearSelectedOverlays();\n      selectedElementId = null;\n    },\n    createSelectionOverlays: (elements, elementId) => {\n      elements.forEach((el) => {\n        const overlay = createOverlay(true);\n        document.body.appendChild(overlay);\n        selectedOverlays.push(overlay);\n        positionOverlay(overlay, el, true);\n      });\n      selectedElementId = elementId;\n    },\n  });\n\n  const clearSelection = () => {\n    inlineEdit.clearSelectedMarks(selectedElementId);\n    clearSelectedOverlays();\n    selectedElementId = null;\n  };\n\n  // Clear hover overlays\n  const clearHoverOverlays = () => {\n    hoverOverlays.forEach((overlay) => {\n      if (overlay && overlay.parentNode) {\n        overlay.remove();\n      }\n    });\n    hoverOverlays = [];\n    currentHighlightedElements = [];\n  };\n\n  const clearSelectedOverlays = () => {\n    selectedOverlays.forEach((overlay) => {\n      if (overlay && overlay.parentNode) {\n        overlay.remove();\n      }\n    });\n    selectedOverlays = [];\n  };\n\n  const TEXT_TAGS = ['p', 'h1', 'h2', 'h3', 'h4', 'h5', 'h6', 'span', 'a', 'label'];\n\n  const notifyElementSelected = (element: Element) => {\n    const htmlElement = element as HTMLElement;\n    const rect = element.getBoundingClientRect();\n    const svgElement = element as SVGElement;\n    const isTextElement = TEXT_TAGS.includes(element.tagName?.toLowerCase());\n\n    const arrEl = htmlElement.closest(\"[data-arr-variable-name]\") as HTMLElement | null;\n    const staticArrayName = arrEl?.dataset?.arrVariableName || null;\n    const rawIdx = arrEl?.dataset?.arrIndex;\n    const staticArrayIndex = rawIdx != null ? parseInt(rawIdx, 10) : null;\n    const staticArrayField = htmlElement.dataset?.arrField || null;\n\n    window.parent.postMessage({\n      type: \"element-selected\",\n      tagName: element.tagName,\n      classes:\n        (svgElement.className as unknown as SVGAnimatedString)?.baseVal ||\n        element.className ||\n        \"\",\n      visualSelectorId: getElementSelectorId(element),\n      content: isTextElement ? htmlElement.innerText : undefined,\n      dataSourceLocation: htmlElement.dataset.sourceLocation,\n      isDynamicContent: htmlElement.dataset.dynamicContent === \"true\",\n      linenumber: htmlElement.dataset.linenumber,\n      filename: htmlElement.dataset.filename,\n      position: {\n        top: rect.top,\n        left: rect.left,\n        right: rect.right,\n        bottom: rect.bottom,\n        width: rect.width,\n        height: rect.height,\n        centerX: rect.left + rect.width / 2,\n        centerY: rect.top + rect.height / 2,\n      },\n      attributes: collectAllowedAttributes(element, ALLOWED_ATTRIBUTES),\n      isTextElement,\n      staticArrayName,\n      staticArrayIndex,\n      staticArrayField,\n    }, \"*\");\n  };\n\n  // Select an element: create overlays, update state, notify parent\n  const selectElement = (element: Element): HTMLDivElement | undefined => {\n    const visualSelectorId = getElementSelectorId(element);\n\n    clearSelectedOverlays();\n\n    const elements = findElementsById(visualSelectorId || null);\n    elements.forEach((el) => {\n      const overlay = createOverlay(true);\n      document.body.appendChild(overlay);\n      selectedOverlays.push(overlay);\n      positionOverlay(overlay, el, true);\n    });\n\n    selectedElementId = visualSelectorId || null;\n    clearHoverOverlays();\n    notifyElementSelected(element);\n\n    return selectedOverlays[0];\n  };\n\n  const notifyDeselection = (): void => {\n    selectedElementId = null;\n    window.parent.postMessage({ type: \"unselect-element\" }, \"*\");\n  };\n\n  // Handle mouse over event\n  const handleMouseOver = (e: MouseEvent) => {\n    if (!isVisualEditMode || isPopoverDragging || inlineEdit.isEditing()) return;\n\n\n    const target = e.target as Element;\n\n    // Prevent hover effects when a dropdown is open\n    if (isDropdownOpen) {\n      clearHoverOverlays();\n      return;\n    }\n\n    // Prevent hover effects on SVG path elements\n    if (target.tagName.toLowerCase() === \"path\") {\n      clearHoverOverlays();\n      return;\n    }\n\n    // Support both data-source-location and data-visual-selector-id\n    const element = target.closest(\n      \"[data-source-location], [data-visual-selector-id]\"\n    );\n    if (!element) {\n      clearHoverOverlays();\n      return;\n    }\n\n    // Prefer data-source-location, fallback to data-visual-selector-id\n    const htmlElement = element as HTMLElement;\n    const selectorId =\n      htmlElement.dataset.sourceLocation ||\n      htmlElement.dataset.visualSelectorId;\n\n    // Skip if this element is already selected\n    if (selectedElementId === selectorId) {\n      clearHoverOverlays();\n      return;\n    }\n\n    // Find all elements with the same ID\n    const elements = findElementsById(selectorId || null);\n\n    // Clear previous hover overlays\n    clearHoverOverlays();\n\n    // Create overlays for all matching elements\n    elements.forEach((el) => {\n      const overlay = createOverlay(false);\n      document.body.appendChild(overlay);\n      hoverOverlays.push(overlay);\n      positionOverlay(overlay, el);\n    });\n\n    currentHighlightedElements = elements;\n  };\n\n  // Handle mouse out event\n  const handleMouseOut = () => {\n    if (isPopoverDragging) return;\n    clearHoverOverlays();\n  };\n\n  // Handle element click\n  const handleElementClick = (e: MouseEvent) => {\n    if (!isVisualEditMode) return;\n\n    const target = e.target as Element;\n\n    // Let layer dropdown clicks pass through without interference\n    if (target.closest(`[${LAYER_DROPDOWN_ATTR}]`)) return;\n\n    // Let clicks inside the editable element pass through to the browser\n    // so the user can reposition the cursor and select text naturally.\n    if (inlineEdit.enabled && target instanceof HTMLElement && target.contentEditable === \"true\") {\n      return;\n    }\n\n    // Clicking outside the editable element exits inline editing mode.\n    if (inlineEdit.isEditing()) {\n      e.preventDefault();\n      e.stopPropagation();\n      e.stopImmediatePropagation();\n      inlineEdit.stopEditing();\n      return;\n    }\n\n    // Close dropdowns when clicking anywhere in iframe if a dropdown is open\n    if (isDropdownOpen) {\n      e.preventDefault();\n      e.stopPropagation();\n      e.stopImmediatePropagation();\n\n      window.parent.postMessage({ type: \"close-dropdowns\" }, \"*\");\n      return;\n    }\n\n    // Prevent clicking on SVG path elements\n    if (target.tagName.toLowerCase() === \"path\") {\n      return;\n    }\n\n    // Prevent default behavior immediately when in visual edit mode\n    e.preventDefault();\n    e.stopPropagation();\n    e.stopImmediatePropagation();\n\n    // Support both data-source-location and data-visual-selector-id\n    const element = target.closest(\n      \"[data-source-location], [data-visual-selector-id]\"\n    );\n    if (!element) {\n      return;\n    }\n\n    const htmlElement = element as HTMLElement;\n    const visualSelectorId = getElementSelectorId(element);\n\n    const isAlreadySelected =\n      selectedElementId === visualSelectorId &&\n      htmlElement.dataset.selected === \"true\";\n\n    if (isAlreadySelected && inlineEdit.enabled && inlineEdit.canEdit(htmlElement)) {\n      inlineEdit.startEditing(htmlElement);\n      return;\n    }\n\n    inlineEdit.stopEditing();\n\n    if (inlineEdit.enabled) {\n      inlineEdit.markElementsSelected(findElementsById(visualSelectorId));\n    }\n\n    const selectedOverlay = selectElement(element);\n    layerController.attachToOverlay(selectedOverlay, element);\n  };\n\n  const unselectElement = () => {\n    inlineEdit.stopEditing();\n    clearSelection();\n  };\n\n  const updateElementClassesAndReposition = (visualSelectorId: string, classes: string) => {\n    const elements = findElementsById(visualSelectorId);\n    if (elements.length === 0) return;\n\n    updateElementClasses(elements, classes);\n\n    // Use a small delay to allow the browser to recalculate layout before repositioning\n    setTimeout(() => {\n      // Reposition selected overlays\n      if (selectedElementId === visualSelectorId) {\n        selectedOverlays.forEach((overlay, index) => {\n          if (index < elements.length) {\n            positionOverlay(overlay, elements[index]!);\n          }\n        });\n      }\n\n      // Reposition hover overlays if needed\n      if (currentHighlightedElements.length > 0) {\n        const hoveredElement = currentHighlightedElements[0] as HTMLElement;\n        const hoveredId = hoveredElement?.dataset?.visualSelectorId;\n        if (hoveredId === visualSelectorId) {\n          hoverOverlays.forEach((overlay, index) => {\n            if (index < currentHighlightedElements.length) {\n              positionOverlay(overlay, currentHighlightedElements[index]!);\n            }\n          });\n        }\n      }\n    }, REPOSITION_DELAY_MS);\n  };\n\n  // Update element attribute by visual selector ID\n  const updateElementAttributeAndReposition = (\n    visualSelectorId: string,\n    attribute: string,\n    value: string\n  ) => {\n    const elements = findElementsById(visualSelectorId);\n    if (elements.length === 0) return;\n\n    updateElementAttribute(elements, attribute, value);\n\n    // Reposition overlays after attribute change (e.g. image src swap can affect layout)\n    setTimeout(() => {\n      if (selectedElementId === visualSelectorId) {\n        selectedOverlays.forEach((overlay, index) => {\n          if (index < elements.length) {\n            positionOverlay(overlay, elements[index]!);\n          }\n        });\n      }\n    }, REPOSITION_DELAY_MS);\n  };\n\n  const updateElementContent = (visualSelectorId: string, content: string, arrIndex?: number) => {\n    let elements = findElementsById(visualSelectorId);\n\n    if (elements.length === 0) {\n      return;\n    }\n\n    if (arrIndex != null) {\n      elements = elements.filter(\n        (el) => (el as HTMLElement).dataset.arrIndex === String(arrIndex)\n      );\n    }\n\n    elements.forEach((element) => {\n      (element as HTMLElement).innerText = content;\n    });\n\n    setTimeout(() => {\n      if (selectedElementId === visualSelectorId) {\n        selectedOverlays.forEach((overlay, index) => {\n          if (index < elements.length) {\n            positionOverlay(overlay, elements[index]!);\n          }\n        });\n      }\n    }, REPOSITION_DELAY_MS);\n  };\n\n  // --- Layer dropdown controller ---\n  const layerController = createLayerController({\n    createPreviewOverlay: (element: Element) => {\n      const overlay = createOverlay(false);\n      overlay.style.zIndex = \"9998\";\n      document.body.appendChild(overlay);\n      positionOverlay(overlay, element);\n      return overlay;\n    },\n    getSelectedElementId: () => selectedElementId,\n    selectElement,\n    onDeselect: notifyDeselection,\n  });\n\n  // Toggle visual edit mode\n  const toggleVisualEditMode = (isEnabled: boolean) => {\n    isVisualEditMode = isEnabled;\n\n    if (!isEnabled) {\n      inlineEdit.stopEditing();\n      clearSelection();\n      layerController.cleanup();\n      clearHoverOverlays();\n\n      currentHighlightedElements = [];\n      document.body.style.cursor = \"default\";\n\n      document.removeEventListener(\"mouseover\", handleMouseOver);\n      document.removeEventListener(\"mouseout\", handleMouseOut);\n      document.removeEventListener(\"click\", handleElementClick, true);\n    } else {\n      document.body.style.cursor = \"crosshair\";\n      document.addEventListener(\"mouseover\", handleMouseOver);\n      document.addEventListener(\"mouseout\", handleMouseOut);\n      document.addEventListener(\"click\", handleElementClick, true);\n    }\n  };\n\n  // Handle scroll events to update popover position\n  const handleScroll = () => {\n    if (selectedElementId) {\n      const elements = findElementsById(selectedElementId);\n      if (elements.length > 0) {\n        const element = elements[0];\n        const rect = element!.getBoundingClientRect();\n\n        const viewportHeight = window.innerHeight;\n        const viewportWidth = window.innerWidth;\n        const isInViewport =\n          rect.top < viewportHeight &&\n          rect.bottom > 0 &&\n          rect.left < viewportWidth &&\n          rect.right > 0;\n\n        const elementPosition = {\n          top: rect.top,\n          left: rect.left,\n          right: rect.right,\n          bottom: rect.bottom,\n          width: rect.width,\n          height: rect.height,\n          centerX: rect.left + rect.width / 2,\n          centerY: rect.top + rect.height / 2,\n        };\n\n        window.parent.postMessage(\n          {\n            type: \"element-position-update\",\n            position: elementPosition,\n            isInViewport: isInViewport,\n            visualSelectorId: selectedElementId,\n          },\n          \"*\"\n        );\n      }\n    }\n  };\n\n  // Handle messages from parent window\n  const handleMessage = (event: MessageEvent) => {\n    const message = event.data;\n\n    switch (message.type) {\n      case \"toggle-visual-edit-mode\":\n        toggleVisualEditMode(message.data.enabled);\n        if (message.data.specs?.newInlineEditEnabled !== undefined) {\n          inlineEdit.enabled = message.data.specs.newInlineEditEnabled;\n        }\n        break;\n\n      case \"update-classes\":\n        if (message.data && message.data.classes !== undefined) {\n          updateElementClassesAndReposition(\n            message.data.visualSelectorId,\n            message.data.classes\n          );\n        } else {\n          console.warn(\n            \"[VisualEditAgent] Invalid update-classes message:\",\n            message\n          );\n        }\n        break;\n\n      case \"update-attribute\":\n        if (\n          message.data &&\n          message.data.visualSelectorId &&\n          message.data.attribute !== undefined &&\n          message.data.value !== undefined\n        ) {\n          updateElementAttributeAndReposition(\n            message.data.visualSelectorId,\n            message.data.attribute,\n            message.data.value\n          );\n        } else {\n          console.warn(\n            \"[VisualEditAgent] Invalid update-attribute message:\",\n            message\n          );\n        }\n        break;\n\n      case \"unselect-element\":\n        unselectElement();\n        break;\n\n      case \"refresh-page\":\n        window.location.reload();\n        break;\n\n      case \"update-content\":\n        if (message.data && message.data.content !== undefined) {\n          updateElementContent(\n            message.data.visualSelectorId,\n            message.data.content,\n            message.data.arrIndex\n          );\n        } else {\n          console.warn(\n            \"[VisualEditAgent] Invalid update-content message:\",\n            message\n          );\n        }\n        break;\n\n      case \"request-element-position\":\n        if (selectedElementId) {\n          const elements = findElementsById(selectedElementId);\n          if (elements.length > 0) {\n            const element = elements[0];\n            const rect = element!.getBoundingClientRect();\n\n            const viewportHeight = window.innerHeight;\n            const viewportWidth = window.innerWidth;\n            const isInViewport =\n              rect.top < viewportHeight &&\n              rect.bottom > 0 &&\n              rect.left < viewportWidth &&\n              rect.right > 0;\n\n            const elementPosition = {\n              top: rect.top,\n              left: rect.left,\n              right: rect.right,\n              bottom: rect.bottom,\n              width: rect.width,\n              height: rect.height,\n              centerX: rect.left + rect.width / 2,\n              centerY: rect.top + rect.height / 2,\n            };\n\n            window.parent.postMessage(\n              {\n                type: \"element-position-update\",\n                position: elementPosition,\n                isInViewport: isInViewport,\n                visualSelectorId: selectedElementId,\n              },\n              \"*\"\n            );\n          }\n        }\n        break;\n\n      case \"popover-drag-state\":\n        if (message.data && message.data.isDragging !== undefined) {\n          isPopoverDragging = message.data.isDragging;\n          if (message.data.isDragging) {\n            clearHoverOverlays();\n          }\n        }\n        break;\n\n      case \"dropdown-state\":\n        if (message.data && message.data.isOpen !== undefined) {\n          isDropdownOpen = message.data.isOpen;\n          if (message.data.isOpen) {\n            clearHoverOverlays();\n          }\n        }\n        break;\n\n      case \"toggle-inline-edit-mode\":\n        if (message.data) {\n          inlineEdit.handleToggleMessage(message.data);\n        }\n        break;\n\n      default:\n        break;\n    }\n  };\n\n  // Handle window resize to reposition overlays\n  const handleResize = () => {\n    if (selectedElementId) {\n      const elements = findElementsById(selectedElementId);\n      selectedOverlays.forEach((overlay, index) => {\n        if (index < elements.length) {\n          positionOverlay(overlay, elements[index]!);\n        }\n      });\n    }\n\n    if (currentHighlightedElements.length > 0) {\n      hoverOverlays.forEach((overlay, index) => {\n        if (index < currentHighlightedElements.length) {\n          positionOverlay(overlay, currentHighlightedElements[index]!);\n        }\n      });\n    }\n  };\n\n  // Initialize: Add IDs to elements that don't have them but have linenumbers\n  const elementsWithLineNumber = document.querySelectorAll(\n    \"[data-linenumber]:not([data-visual-selector-id])\"\n  );\n  elementsWithLineNumber.forEach((el, index) => {\n    const htmlEl = el as HTMLElement;\n    const id = `visual-id-${htmlEl.dataset.filename}-${htmlEl.dataset.linenumber}-${index}`;\n    htmlEl.dataset.visualSelectorId = id;\n  });\n\n  // Create mutation observer to detect layout changes\n  const mutationObserver = new MutationObserver((mutations) => {\n    const needsUpdate = mutations.some((mutation) => {\n      const hasVisualId = (node: Node): boolean => {\n        if (node.nodeType === Node.ELEMENT_NODE) {\n          const el = node as HTMLElement;\n          if (el.dataset && el.dataset.visualSelectorId) {\n            return true;\n          }\n          for (let i = 0; i < el.children.length; i++) {\n            if (hasVisualId(el.children[i]!)) {\n              return true;\n            }\n          }\n        }\n        return false;\n      };\n\n      const isLayoutChange =\n        mutation.type === \"attributes\" &&\n        (mutation.attributeName === \"style\" ||\n          mutation.attributeName === \"class\" ||\n          mutation.attributeName === \"width\" ||\n          mutation.attributeName === \"height\");\n\n      return isLayoutChange && hasVisualId(mutation.target);\n    });\n\n    if (needsUpdate) {\n      setTimeout(handleResize, REPOSITION_DELAY_MS);\n    }\n  });\n\n  // Set up event listeners\n  window.addEventListener(\"message\", handleMessage);\n  window.addEventListener(\"scroll\", handleScroll, true);\n  document.addEventListener(\"scroll\", handleScroll, true);\n  window.addEventListener(\"resize\", handleResize);\n  window.addEventListener(\"scroll\", handleResize);\n\n  // Start observing DOM mutations\n  mutationObserver.observe(document.body, {\n    attributes: true,\n    childList: true,\n    subtree: true,\n    attributeFilter: [\"style\", \"class\", \"width\", \"height\"],\n  });\n\n  // Send ready message to parent\n  window.parent.postMessage({ type: \"visual-edit-agent-ready\" }, \"*\");\n}"],"mappings":"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","names":["isInstrumentedElement","element","htmlEl","getElementSelectorId","ALLOWED_ATTRIBUTES","findElementsById","id","sourceElements","updateElementClasses","elements","classes","updateElementAttribute","attribute","value","collectAllowedAttributes","allowedAttributes","attributes","attr","val","DROPDOWN_CONTAINER_STYLES","DROPDOWN_ITEM_BASE_STYLES","DROPDOWN_ITEM_ACTIVE_COLOR","DROPDOWN_ITEM_ACTIVE_BG","DROPDOWN_ITEM_ACTIVE_FONT_WEIGHT","DROPDOWN_ITEM_HOVER_BG","DEPTH_INDENT_PX","CHEVRON_COLLAPSED","CHEVRON_EXPANDED","BASE_PADDING_PX","LAYER_DROPDOWN_ATTR","MAX_PARENT_DEPTH","MAX_CHILD_DEPTH","applyStyles","element","styles","key","m","getLayerDisplayName","layer","toLayerInfo","depth","info","getElementSelectorId","getInstrumentedDescendants","parent","maxDepth","startDepth","result","walk","el","instrDepth","i","child","isInstrumentedElement","collectInstrumentedParents","selectedElement","parents","current","MAX_PARENT_DEPTH","addParentsToChain","chain","p","addSelfAndDescendantsToChain","selfDepth","descendants","MAX_CHILD_DEPTH","getImmediateInstrParent","collectSiblings","siblings","s","appendSiblingsWithSelected","selectedSelectorId","seen","sibling","id","buildLayerChain","instrParent","activeDropdown","activeLabel","outsideMousedownHandler","activeOnHoverEnd","activeKeydownHandler","createDropdownItem","layer","isActive","onSelect","onHover","onHoverEnd","item","getLayerDisplayName","applyStyles","DROPDOWN_ITEM_BASE_STYLES","depth","BASE_PADDING_PX","DEPTH_INDENT_PX","DROPDOWN_ITEM_ACTIVE_COLOR","DROPDOWN_ITEM_ACTIVE_BG","DROPDOWN_ITEM_ACTIVE_FONT_WEIGHT","DROPDOWN_ITEM_HOVER_BG","e","createDropdownElement","layers","currentElement","callbacks","container","LAYER_DROPDOWN_ATTR","DROPDOWN_CONTAINER_STYLES","enhanceLabelWithChevron","label","t","CHEVRON_COLLAPSED","CHEVRON_EXPANDED","setupKeyboardNavigation","dropdown","items","focusedIndex","l","setFocusedItem","index","prev","cur","closeDropdown","setupOutsideClickHandler","skipFirst","target","showDropdown","overlay","isDropdownOpen","createLayerController","config","layerPreviewOverlay","escapeHandler","dropdownSourceLayer","clearLayerPreview","showLayerPreview","layer","getElementSelectorId","selectLayer","closeDropdown","firstOverlay","attachToOverlay","restoreSelection","handleLabelClick","e","label","element","layers","currentId","isDropdownOpen","ev","showDropdown","overlay","buildLayerChain","enhanceLabelWithChevron","FOCUS_STYLE_ID","EDITABLE_TAGS","isStaticArrayTextElement","element","passesStructuralChecks","injectFocusOutlineCSS","style","removeFocusOutlineCSS","selectText","range","selection","isEditableTextElement","shouldEnterInlineEditingMode","DEBOUNCE_MS","createInlineEditController","host","currentEditingElement","debouncedSendTimeout","enabled","listenerAbortControllers","repositionOverlays","selectedId","elements","overlay","i","reportEdit","element","originalContent","newContent","svgElement","rect","message","isStaticArrayTextElement","debouncedReport","onTextInput","handleInputEvent","makeEditable","injectFocusOutlineCSS","abortController","selectText","makeNonEditable","removeFocusOutlineCSS","value","shouldEnterInlineEditingMode","o","el","elementId","data","setupVisualEditAgent","isVisualEditMode","isPopoverDragging","isDropdownOpen","hoverOverlays","selectedOverlays","currentHighlightedElements","selectedElementId","REPOSITION_DELAY_MS","createOverlay","isSelected","overlay","positionOverlay","element","rect","label","inlineEdit","createInlineEditController","findElementsById","clearSelectedOverlays","elements","elementId","el","clearSelection","clearHoverOverlays","TEXT_TAGS","notifyElementSelected","htmlElement","svgElement","isTextElement","arrEl","staticArrayName","rawIdx","staticArrayIndex","staticArrayField","getElementSelectorId","collectAllowedAttributes","ALLOWED_ATTRIBUTES","selectElement","visualSelectorId","notifyDeselection","handleMouseOver","e","target","selectorId","handleMouseOut","handleElementClick","LAYER_DROPDOWN_ATTR","selectedOverlay","layerController","unselectElement","updateElementClassesAndReposition","classes","updateElementClasses","index","updateElementAttributeAndReposition","attribute","value","updateElementAttribute","updateElementContent","content","arrIndex","createLayerController","toggleVisualEditMode","isEnabled","handleScroll","viewportHeight","viewportWidth","isInViewport","elementPosition","handleMessage","event","message","handleResize","htmlEl","id","mutationObserver","mutations","mutation","hasVisualId","node","i"]}